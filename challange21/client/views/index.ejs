<%- include("partials/_header") %>

<body style="font-family: 'Fresca', sans-serif;">
  <div class="container">
    <h1 class="text-center">BREAD<br> <small>(Browse, Read, Edit, Add, Delete)</small> </h1>
    <hr>
    <h2>Filters</h2>
    <form id="form-control" method="GET">
      <input type="hidden" id="page" name="page" value="1">
      <div class="form-group row">
        <label for="inputID" class="col-sm-2 col-form-label"> <input type="checkbox" name="checkID"> ID</label>

        <div class="col-sm-10">
          <input type="text" class="form-control" name='inputID' placeholder="ID">
        </div>
      </div>
      <div class="form-group row">
        <label for="inputString" class="col-sm-2 col-form-label"> <input type="checkbox" name="checkString">
          String</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" name='inputString' placeholder="String">
        </div>
      </div>
      <div class="form-group row">
        <label for="inputInteger" class="col-sm-2 col-form-label"> <input type="checkbox" name="checkInteger">
          Integer</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" name='inputInteger' placeholder="Integer">
        </div>
      </div>
      <div class="form-group row">
        <label for="inputFloat" class="col-sm-2 col-form-label"> <input type="checkbox" name="checkFloat">
          Float</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" name='inputFloat' placeholder="Float">
        </div>
      </div>
      <div class="form-group row">
        <label for="startDate" class="col-sm-2 col-form-label"> <input type="checkbox" name="checkDate">
          Date</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" name='startDate' placeholder="start date"> to
          <input type="text" class="form-control" name='endDate' placeholder="end date">
        </div>
      </div>
      <div class="form-group row">
        <label for="inputBoolean" class="col-sm-2 col-form-label"> <input type="checkbox" name="checkBoolean">
          Boolean</label>
        <div class="col-sm-10">
          <select class="custom-select" name="inputBoolean">
            <option value="false">false</option>
            <option value="true" selected>true</option>
          </select>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Search</button>
      <a class="btn btn-success btn" href="/" role="button">Show All</a>
    </form>

    <br>

    <table class="table table-striped">
      <thead>
        <tr>
          <th scope="col">ID</th>
          <th scope="col">String</th>
          <th scope="col">Integer</th>
          <th scope="col">Float</th>
          <th scope="col">Date</th>
          <th scope="col">Boolean</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    <br>

    <nav aria-label="Page navigation example">
      <ul class="pagination justify-content-center">
      </ul>
    </nav>

    <a class="btn btn-primary btn-add" href="/add" role="button" on>Add</a>


    <!-- Modal Edit -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModal" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="editModalLabel">Edit Data</h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <form id="form-edit">
            <div class="modal-body">
              <div class="form-group row">
                <label for="inputString" class="col-sm-2 col-form-label">ID</label>
                <div class="col-sm-10">
                  <input type="number" id="modalId" class="form-control" name="id" value="" disabled>
                </div>
              </div>
              <div class="form-group row">
                <label for="inputString" class="col-sm-2 col-form-label">String</label>
                <div class="col-sm-10">
                  <input type="text" id="modalString" class="form-control" name="string" placeholder="String" value="">
                </div>
              </div>
              <div class="form-group row">
                <label for="inputInteger" class="col-sm-2 col-form-label">Integer</label>
                <div class="col-sm-10">
                  <input type="text" id="modalInteger" class="form-control" name="integer" placeholder="Integer"
                    value="">
                </div>
              </div>
              <div class="form-group row">
                <label for="inputFloat" class="col-sm-2 col-form-label">Float</label>
                <div class="col-sm-10">
                  <input type="text" id="modalFloat" class="form-control" name="float" placeholder="Float" value="">
                </div>
              </div>
              <div class="form-group row">
                <label for="inputPassword" class="col-sm-2 col-form-label">Date</label>
                <div class="col-sm-10">
                  <input type="date" id="modalDate" class="form-control" name="date" value="">
                </div>
              </div>
              <div class="form-group row">
                <label for="inputBoolean" class="col-sm-2 col-form-label">Boolean</label>
                <div class="col-sm-10">
                  <select id="modalBoolean" class="custom-select" name="boolean">
                  </select>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" id="submit-data" class="btn btn-outline-primary btn-save-change" dataid=""
                data-dismiss="modal">Save changes</button>
              <button type="button" class="btn btn-outline-danger" data-dismiss="modal">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>

  </div>
  <br>

  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
  </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
  </script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script type="text/javascript">
    const apiUrl = "http://localhost:3000/api";
    $(document).ready(() => {
      loadData();
      $('#form-control').submit((e) => {
        e.preventDefault();
      });

      $('table tbody').on('click', '.btn-edit', (event) => {
        showData($(event.currentTarget).attr('data-id'));
      })

      $('table tbody').on('click', '.btn-delete', (event) => {
        event.preventDefault();
        deleteData($(event.currentTarget).attr('data-id'))
      })

      $('.modal-footer').on('click', '.btn-save-change', (event) => {
        event.preventDefault();
        saveData($(event.currentTarget).attr('dataid'));
        loadData();
      })

      $('ul.pagination').on('click', '.previous', (event) => {
        let page = $('input#page').val();
        $('input#page').val(parseInt(page) - 1);
        loadData();
      })

      $('ul.pagination').on('click', '.pageNow', (event) => {
        let page = $('input#page').val();
        $('input#page').val($(event.currentTarget).attr('data-page'));
        loadData();
      })

      $('ul.pagination').on('click', '.next', (event) => {
        let page = $('input#page').val();
        $('input#page').val(parseInt(page) + 1);
        loadData();
      })

    })

    const showData = param => {
      $.ajax({
          method: "GET",
          url: `${apiUrl}/${param}`,
          dataType: 'json'
        })
        .done(result => {
          let data = result.result;
          let html = '';
          data.forEach(item => {
            $('button#submit-data').attr('dataid', item.id);
            $('input#modalId').val(item.id);
            $('button#yesdelete').val(item.id);
            $('input#modalString').val(item.string);
            $('input#modalInteger').val(item.integer);
            $('input#modalFloat').val(item.float);
            $('input#modalDate').val(item.date);
            if (item.boolean) {
              html += `<option value="false">false</option>
              <option value="true" selected>true</option>`
            } else {
              html += `<option value="false" selected>false</option>
              <option value="true">true</option>`
            }
          })
          $('#modalBoolean').html(html);
        })
    }

    const loadData = () => {
      const data = $('#form-control').serializeArray();
      $.ajax({
          method: 'GET',
          url: `${apiUrl}`,
          data: data,
          dataType: 'json'
        })
        .done((result) => {
          const value = result.result
          let pageNow = $('#page').val();
          if(value.length == 0 && pageNow != '1') {
            $('#page').val(pageNow - 1);
            loadData();
          }
          let html = '';
          value.forEach(item => {
            html += `<tr>
            <td>${item.id}</td>
            <td>${item.string}</td>
            <td>${item.integer}</td>
            <td>${item.float}</td>
            <td>${item.date}</td>
            <td>${item.boolean}</td>
            <td>
                <button type="button" class="btn btn-success btn-edit" data-id="${item.id}" data-toggle="modal" data-target="#editModal">Edit</button>
                <button type="button" class="btn btn-danger btn-delete" data-id="${item.id}">Delete</button>
        </tr>`
          })

          $('table tbody').html(html);

          let currentPage = result.currentPage;
          let totalPage = result.totalPage;
          let url = result.url;

          let pagination =
            `<li class="page-item ${currentPage <=1 ? ' disabled' : ''}"><button class="page-link previous" tabindex="-1" aria-disabled="true">Previous</button></li>\n`;
          for (let i = 1; i <= totalPage; i++) {
            pagination +=
              `<li class="page-item ${currentPage == i ? 'active': ''}"><button class="page-link pageNow" data-page='${i}'>${i}</button></li>\n`
          }

          pagination +=
            `<li class="page-item ${currentPage >= totalPage ? ' disabled' : ''}"><button class="page-link next">Next</button></li>`;

          $('nav ul').html(pagination);
        })
    }

    const deleteData = (id) => {
      $.ajax({
          method: "DELETE",
          url: `${apiUrl}/${id}`,
          dataType: 'json'
        })
        .done((result) => {
          loadData();
        })
    }

    const saveData = (param) => {
      $.ajax({
          method: "PUT",
          url: `${apiUrl}/${param}`,
          data: {
            id: `${param}`,
            string: $('#modalString').val(),
            integer: $('#modalInteger').val(),
            float: $('#modalFloat').val(),
            date: $('#modalDate').val(),
            boolean: $('#modalBoolean').val(),
          },
          dataType: 'json'
        })
        .done((result) => {
          loadData();
          $('#editModal').modal('hide')
        })
    }
  </script>
</body>

</html>